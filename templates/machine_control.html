<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机器控制面板 - {{ machine_name }}</title>

    <style>
        .control-panel {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .machine-header {
            background: #343a40;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .control-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        .control-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.2s;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { transform: translateY(-1px); }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .status-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }
        .log-container {
            height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s;
        }
        .monitor-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .register-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .register-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .register-table th,
        .register-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .register-table th {
            background: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .register-table tr:hover {
            background: #f5f5f5;
        }
        .register-value {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .register-error {
            color: #dc3545;
            font-style: italic;
        }
        .register-success {
            color: #28a745;
        }
        .register-category {
            background: #e3f2fd !important;
            font-weight: bold;
            color: #1976d2;
        }
        .loading-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <div class="machine-header">
            <div>
                <h1>{{ machine_name }} 控制面板</h1>
                <p>位置: {{ location }} | IP: {{ plc_host }}:{{ plc_port }}</p>
            </div>
            <div class="status-display">
                <span id="connectionStatus" class="status-offline">离线</span>
                <div id="systemInfo" style="margin-top: 10px; font-size: 12px; color: #666;">
                    连接状态: 离线<br>
                    最后通信: 无<br>
                    系统状态: 未知
                </div>
            </div>
        </div>

        <div class="control-sections">
            <!-- 舱门控制 -->
            <div class="control-section">
                <div class="section-title">舱门控制</div>
                <div class="status-display" id="doorStatus">舱门状态: 未知</div>
                <button class="btn btn-success" onclick="controlDoor('open')">开启舱门</button>
                <button class="btn btn-warning" onclick="controlDoor('close')">关闭舱门</button>
                <button class="btn btn-secondary" onclick="getDoorStatus()">查询状态</button>
            </div>

            <!-- 存件流程 -->
            <div class="control-section">
                <div class="section-title">存件流程</div>
                <div class="status-display" id="storageStatus">存件状态: 待机</div>
                <div class="status-display" id="pickupStatus">取件状态: 待机</div>
                <div class="input-group">
                    <label>取件码前三位:</label>
                    <input type="text" id="pickupCodeFirst" maxlength="3" placeholder="前三位">
                </div>
                <div class="input-group">
                    <label>取件码后三位:</label>
                    <input type="text" id="pickupCodeLast" maxlength="3" placeholder="后三位">
                </div>
                <button class="btn btn-primary" onclick="confirmStorageStart()">确认存件开始</button>
                <button class="btn btn-success" onclick="executeStorageProcess()">执行存件流程</button>
                <div class="progress-bar">
                    <div class="progress-fill" id="storageProgress" style="width: 0%"></div>
                </div>
            </div>



            <!-- 寄件流程 -->
            <div class="control-section">
                <div class="section-title">寄件流程</div>
                <div class="status-display" id="sendStatus">寄件状态: 待机</div>
                <div class="status-display" id="sendOperationStatus">操作状态: 未知</div>
                <div class="input-group">
                    <label>寄件码前三位:</label>
                    <input type="text" id="sendCodeFirst" maxlength="3" placeholder="前三位">
                </div>
                <div class="input-group">
                    <label>寄件码后三位:</label>
                    <input type="text" id="sendCodeLast" maxlength="3" placeholder="后三位">
                </div>
                <button class="btn btn-primary" onclick="setSendCode()">设置寄件码</button>
                <button class="btn btn-success" onclick="startSendProcess()">开始寄件流程</button>
                <button class="btn btn-secondary" onclick="getSendStatus()">查询寄件状态</button>
                <button class="btn btn-warning" onclick="startSendMonitoring()">开始监视</button>
                <button class="btn btn-danger" onclick="stopSendMonitoring()">停止监视</button>
            </div>

            <!-- 系统监控 -->
+

            <!-- 寄存器监视器 -->
            <div class="control-section" style="grid-column: 1 / -1;">
                <div class="section-title">寄存器监视器</div>
                <div class="monitor-controls">
                    <button class="btn btn-primary" onclick="startRegisterMonitoring()">开始监视</button>
                    <button class="btn btn-danger" onclick="stopRegisterMonitoring()">停止监视</button>
                    <button class="btn btn-secondary" onclick="refreshRegisters()">手动刷新</button>
                    <span class="status-display" id="monitorStatus">监视状态: 停止</span>
                    <span class="status-display" id="registerUpdateTime">最后更新: 未更新</span>
                </div>
                <div class="register-container" id="registerContainer">
                    <div class="loading-message">点击"开始监视"或"手动刷新"来加载寄存器数据</div>
                </div>
            </div>

            <!-- 操作日志 -->
            <div class="control-section" style="grid-column: 1 / -1;">
                <div class="section-title">操作日志</div>
                <button class="btn btn-secondary" onclick="clearLogs()">清空日志</button>
                <div class="log-container" id="operationLogs"></div>
            </div>
        </div>
    </div>

    <script>
        const machineName = '{{ machine_name }}';
        let logs = [];
        let securityKey = null;

        // 初始化安全key
        function initSecurityKey() {
            // 从URL参数获取key
            const urlParams = new URLSearchParams(window.location.search);
            const keyFromUrl = urlParams.get('key');
            
            if (keyFromUrl) {
                // 保存key到localStorage
                localStorage.setItem('securityKey', keyFromUrl);
                securityKey = keyFromUrl;
                addLog('安全key已设置', 'success');
                
                // 清除URL中的key参数（可选）
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            } else {
                // 从localStorage获取key
                securityKey = localStorage.getItem('securityKey');
                if (!securityKey) {
                    addLog('警告: 未找到安全key，请通过正确的链接访问', 'error');
                }
            }
        }

        // 为API请求添加key参数
        function addKeyToUrl(url) {
            if (!securityKey) return url;
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}key=${securityKey}`;
        }

        // 移除window.onload，使用DOMContentLoaded事件

        // 添加日志
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.unshift(`[${timestamp}] ${message}`);
            if (logs.length > 100) logs.pop();
            updateLogDisplay();
        }

        // 更新日志显示
        function updateLogDisplay() {
            document.getElementById('operationLogs').innerHTML = logs.join('\n');
        }

        // 清空日志
        function clearLogs() {
            logs = [];
            updateLogDisplay();
        }

        // 舱门控制
        async function controlDoor(action) {
            try {
                addLog(`正在${action === 'open' ? '开启' : '关闭'}舱门...`);
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/door/${action}`), {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    addLog(`舱门${action === 'open' ? '开启' : '关闭'}成功`);
                    getDoorStatus();
                } else {
                    addLog(`舱门操作失败: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`舱门操作异常: ${error.message}`, 'error');
            }
        }

        // 获取舱门状态
        async function getDoorStatus() {
            try {
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/door/status`));
                const result = await response.json();
                
                if (result.success && result.data) {
                    document.getElementById('doorStatus').textContent = `舱门状态: ${result.data.status || '未知'}`;
                } else {
                    document.getElementById('doorStatus').textContent = `舱门状态: 获取失败`;
                    addLog(`获取舱门状态失败: ${result.message || '未知错误'}`, 'error');
                }
            } catch (error) {
                document.getElementById('doorStatus').textContent = `舱门状态: 连接异常`;
                addLog(`获取舱门状态失败: ${error.message}`, 'error');
            }
        }

        // 确认存件开始
        async function confirmStorageStart() {
            try {
                addLog('确认存件开始...');
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/storage/confirm-start`), {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    addLog('存件开始确认成功，请执行存件流程');
                    updateStorageProgress(25);
                } else {
                    addLog(`存件开始确认失败: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`存件开始确认异常: ${error.message}`, 'error');
            }
        }

        // 执行完整存件流程
        async function executeStorageProcess() {
            const codeFirst = document.getElementById('pickupCodeFirst').value;
            const codeLast = document.getElementById('pickupCodeLast').value;
            
            if (!codeFirst || !codeLast) {
                alert('请输入完整的取件码');
                return;
            }

            try {
                addLog('执行存件流程...');
                updateStorageProgress(50);
                
                // 下发取件码并执行完整流程
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/storage/execute`), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pickup_code_first: codeFirst,
                        pickup_code_last: codeLast
                    })
                });
                const result = await response.json();
                if (result.success) {
                    addLog('存件流程执行成功，货叉到位，延时10秒后舵机操作');
                    updateStorageProgress(100);
                } else {
                    addLog(`存件流程执行失败: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`存件流程执行异常: ${error.message}`, 'error');
            }
        }



        // 更新存件进度
        function updateStorageProgress(percent) {
            document.getElementById('storageProgress').style.width = percent + '%';
        }

        // 设置取件码
        async function setPickupCode() {
            const codeFirst = document.getElementById('pickupCodeFirst').value;
            const codeLast = document.getElementById('pickupCodeLast').value;
            
            if (!codeFirst || !codeLast) {
                alert('请输入完整的取件码');
                return;
            }

            try {
                addLog('设置取件码...');
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/pickup/set-code`), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pickup_code_first: codeFirst,
                        pickup_code_last: codeLast
                    })
                });
                const result = await response.json();
                if (result.success) {
                    addLog('取件码设置成功');
                } else {
                    addLog(`取件码设置失败: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`取件码设置异常: ${error.message}`, 'error');
            }
        }

        // 取件流程
        async function startPickupProcess() {
            const codeFirst = document.getElementById('pickupCodeFirst').value;
            const codeLast = document.getElementById('pickupCodeLast').value;
            
            if (!codeFirst || !codeLast) {
                alert('请输入完整的取件码');
                return;
            }

            try {
                addLog('开始取件流程...');
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/pickup/start`), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pickup_code_first: codeFirst,
                        pickup_code_last: codeLast
                    })
                });
                const result = await response.json();
                if (result.success) {
                    addLog('取件流程启动成功');
                } else {
                    addLog(`取件流程启动失败: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`取件流程异常: ${error.message}`, 'error');
            }
        }

        // 打开回收箱
        async function openRecycleBox() {
            try {
                addLog('打开回收箱...');
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/pickup/recycle`), {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    addLog('回收箱打开成功');
                } else {
                    addLog(`回收箱打开失败: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`回收箱操作异常: ${error.message}`, 'error');
            }
        }

        // 获取取件状态
        async function getPickupStatus() {
            try {
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/pickup/status`));
                const result = await response.json();
                
                if (result.success && result.data) {
                    document.getElementById('pickupStatus').textContent = `取件状态: ${result.data.status || '待机'}`;
                } else {
                    document.getElementById('pickupStatus').textContent = `取件状态: 获取失败`;
                    addLog(`获取取件状态失败: ${result.message || '未知错误'}`, 'error');
                }
            } catch (error) {
                document.getElementById('pickupStatus').textContent = `取件状态: 连接异常`;
                addLog(`获取取件状态失败: ${error.message}`, 'error');
            }
        }

        // 检查寄件格口状态
        async function checkSendBoxStatus() {
            try {
                const response = await fetch(addKeyToUrl(`/api/modbus/read`), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: 0xBD2,
                        machine_name: machineName
                    })
                });
                const result = await response.json();
                if (result.success && result.data && result.data.value !== undefined) {
                    const status = result.data.value;
                    if (status === 11) { // 0x0B - 无空寄件箱不可寄件
                        return { success: false, message: '当前无空寄件箱，无法设置寄件码' };
                    } else if (status !== 10) { // 0x0A - 有空寄件箱可寄件
                        return { success: false, message: `寄件格口状态异常，无法设置寄件码: ${status}` };
                    }
                    return { success: true, message: '寄件格口状态正常' };
                } else {
                    return { success: false, message: '无法读取寄件格口状态' };
                }
            } catch (error) {
                return { success: false, message: `检查寄件格口状态异常: ${error.message}` };
            }
        }

        // 设置寄件码
        async function setSendCode() {
            const codeFirst = document.getElementById('sendCodeFirst').value;
            const codeLast = document.getElementById('sendCodeLast').value;
            
            if (!codeFirst || !codeLast) {
                alert('请输入完整的寄件码');
                return;
            }

            try {
                // 先检查寄件格口状态
                addLog('检查寄件格口状态...');
                const statusCheck = await checkSendBoxStatus();
                if (!statusCheck.success) {
                    addLog(`寄件格口状态检查失败: ${statusCheck.message}`, 'error');
                    alert(statusCheck.message);
                    return;
                }
                addLog('寄件格口状态检查通过');

                addLog('设置寄件码...');
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/send/set-code`), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        send_code_first: codeFirst,
                        send_code_last: codeLast
                    })
                });
                const result = await response.json();
                if (result.success) {
                    addLog('寄件码设置成功');
                } else {
                    addLog(`寄件码设置失败: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`寄件码设置异常: ${error.message}`, 'error');
            }
        }

        // 开始寄件流程
        async function startSendProcess() {
            const codeFirst = document.getElementById('sendCodeFirst').value;
            const codeLast = document.getElementById('sendCodeLast').value;
            
            if (!codeFirst || !codeLast) {
                alert('请输入完整的寄件码');
                return;
            }

            try {
                addLog('开始寄件流程...');
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/send/start`), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        send_code_first: codeFirst,
                        send_code_last: codeLast
                    })
                });
                const result = await response.json();
                if (result.success) {
                    addLog('寄件流程启动成功');
                } else {
                    addLog(`寄件流程启动失败: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`寄件流程异常: ${error.message}`, 'error');
            }
        }

        // 获取寄件状态
        async function getSendStatus() {
            try {
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/send/status`));
                const result = await response.json();
                
                if (result.success && result.data) {
                    document.getElementById('sendStatus').textContent = `寄件状态: ${result.data.status || '待机'}`;
                } else {
                    document.getElementById('sendStatus').textContent = `寄件状态: 获取失败`;
                    addLog(`获取寄件状态失败: ${result.message || '未知错误'}`, 'error');
                }
            } catch (error) {
                document.getElementById('sendStatus').textContent = `寄件状态: 连接异常`;
                addLog(`获取寄件状态失败: ${error.message}`, 'error');
            }
        }

        // 获取寄件操作状态 (监视0xBC7)
        async function getSendOperationStatus() {
            try {
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/send/operation-status`));
                const result = await response.json();
                
                if (result.success && result.data) {
                    const statusText = `操作状态: ${result.data.status_description} (${result.data.hex_value})`;
                    document.getElementById('sendOperationStatus').textContent = statusText;
                    
                    // 根据状态值添加日志
                    if (result.data.raw_status === 210) {
                        addLog('检测到: 正在取空箱');
                    } else if (result.data.raw_status === 211) {
                        addLog('检测到: 取空箱完成');
                    } else if (result.data.raw_status === 220) {
                        addLog('检测到: 用户存寄件箱中');
                    } else if (result.data.raw_status === 230) {
                        addLog('检测到: 正在存寄件箱');
                    } else if (result.data.raw_status === 231) {
                        addLog('检测到: 存寄件箱完成');
                        // 寄件完成，可以停止监视
                        if (sendMonitoringInterval) {
                            addLog('寄件流程完成，自动停止监视');
                            stopSendMonitoring();
                        }
                    }
                } else {
                    document.getElementById('sendOperationStatus').textContent = `操作状态: 获取失败`;
                    addLog(`获取寄件操作状态失败: ${result.message || '未知错误'}`, 'error');
                }
            } catch (error) {
                document.getElementById('sendOperationStatus').textContent = `操作状态: 连接异常`;
                addLog(`获取寄件操作状态失败: ${error.message}`, 'error');
            }
        }

        // 寄件监视相关变量
        let sendMonitoringInterval = null;

        // 开始寄件监视
        function startSendMonitoring() {
            if (sendMonitoringInterval) {
                addLog('寄件监视已在运行中');
                return;
            }
            
            addLog('开始监视寄件操作状态 (0xBC7)');
            // 立即获取一次状态
            getSendOperationStatus();
            
            // 每2秒轮询一次
            sendMonitoringInterval = setInterval(() => {
                getSendOperationStatus();
            }, 2000);
        }

        // 停止寄件监视
        function stopSendMonitoring() {
            if (sendMonitoringInterval) {
                clearInterval(sendMonitoringInterval);
                sendMonitoringInterval = null;
                addLog('已停止监视寄件操作状态');
            } else {
                addLog('寄件监视未在运行');
            }
        }

        // 获取系统状态
        async function getSystemStatus() {
            try {
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/status`));
                const result = await response.json();
                
                if (result.success && result.data && result.data.status) {
                    const status = result.data.status;
                    const stats = status.connection_stats || {};
                    const connected = stats.connected || false;
                    
                    document.getElementById('systemInfo').innerHTML = `
                        连接状态: ${connected ? '在线' : '离线'}<br>
                        最后通信: ${stats.last_used ? new Date(stats.last_used * 1000).toLocaleString() : '无'}<br>
                        系统状态: ${connected ? '正常' : '离线'}
                    `;
                    document.getElementById('connectionStatus').textContent = connected ? '在线' : '离线';
                    document.getElementById('connectionStatus').className = connected ? 'status-online' : 'status-offline';
                } else {
                    addLog(`获取系统状态失败: ${result.message || '未知错误'}`, 'error');
                    document.getElementById('systemInfo').innerHTML = '获取状态失败';
                    document.getElementById('connectionStatus').textContent = '离线';
                    document.getElementById('connectionStatus').className = 'status-offline';
                }
            } catch (error) {
                addLog(`获取系统状态失败: ${error.message}`, 'error');
                document.getElementById('systemInfo').innerHTML = '获取状态异常';
                document.getElementById('connectionStatus').textContent = '离线';
                document.getElementById('connectionStatus').className = 'status-offline';
            }
        }

        // 测试连接
        async function testConnection() {
            try {
                addLog('测试连接...');
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/test`));
                const result = await response.json();
                if (result.success) {
                    addLog('连接测试成功');
                } else {
                    addLog(`连接测试失败: ${result.message}`, 'error');
                }
                getSystemStatus();
            } catch (error) {
                addLog(`连接测试异常: ${error.message}`, 'error');
            }
        }

        // 寄存器监视器相关变量
        let registerMonitoringInterval = null;
        let registerData = {};

        // 获取所有寄存器数据
        async function getAllRegisters() {
            try {
                const response = await fetch(addKeyToUrl(`/api/machines/${machineName}/registers/all`));
                const result = await response.json();
                
                if (result.success && result.data) {
                    registerData = result.data.registers;
                    updateRegisterDisplay();
                    document.getElementById('registerUpdateTime').textContent = `最后更新: ${new Date().toLocaleTimeString()}`;
                    
                    // 更新监视状态统计
                    const totalCount = result.data.total_count;
                    const successCount = result.data.success_count;
                    const failedCount = result.data.failed_count;
                    
                    addLog(`寄存器读取完成: 成功${successCount}/${totalCount}个，失败${failedCount}个`);
                } else {
                    addLog(`获取寄存器数据失败: ${result.message || '未知错误'}`, 'error');
                }
            } catch (error) {
                addLog(`获取寄存器数据异常: ${error.message}`, 'error');
            }
        }

        // 根据寄存器地址和值获取状态描述
        function getRegisterStatusDescription(address, decValue) {
            const statusMap = {
                '0xBB8': { // 舱门操作
                    0: '空位',
                    10: '开舱门',
                    11: '开舱门到位',
                    20: '关舱门',
                    21: '关舱门到位'
                },
                '0xBB9': { // 停机坪无人机判断
                    0: '空位',
                    10: '有飞机',
                    11: '有飞机确认',
                    20: '无飞机',
                    21: '无飞机确认'
                },
                '0xBBA': { // 无人机存、取包裹操作
                    0: '空位',
                    110: '存包裹',
                    111: '存包裹完毕',
                    120: '无人机取件中',
                    121: '无人机取件完成',
                    122: '无人机不取件完成（可起飞）'
                },
                '0xBBB': { // 无人机舵机状态
                    0: '空位',
                    1: '无人机对正完成，可开舵机',
                    2: '无人机取包裹完成，可关舵机',
                    10: '舵机开',
                    11: '舵机开确认',
                    20: '舵机关',
                    21: '舵机关确认'
                },
                '0xBBC': { // 无人机当前存包裹位置
                    101: '1#位置',
                    102: '2#位置',
                    103: '3#位置'
                },
                '0xBBD': { // 无人机当前取包裹位置
                    104: '4#位置',
                    105: '5#位置',
                    106: '6#位置'
                },
                '0xBBE': { // 无人机存件格口状态
                    0: '空位',
                    10: '机柜已存满',
                    20: '机柜未存满'
                },
                '0xBC2': { // 取包裹位置信息
                    101: '1#位置',
                    102: '2#位置',
                    103: '3#位置'
                },
                '0xBC3': { // 用户取包裹操作
                    210: '取包裹',
                    211: '取包裹完毕'
                },
                '0xBC4': { // 用户回收包裹操作（开箱门）
                    210: '回收步骤-开箱门中',
                    211: '回收步骤-开箱门完成'
                },
                '0xBC5': { // 用户确认回收包裹操作
                    210: '回收包裹中',
                    211: '回收包裹完毕'
                },
                '0xBC6': { // 用户寄件取空箱格口信息
                    104: '4#位置',
                    105: '5#位置',
                    106: '6#位置'
                },
                '0xBC7': { // 用户寄件操作
                    0: '空位',
                    210: '用户取空箱中/用户存寄件箱二次确认',
                    211: '用户取空箱完毕/用户存寄件箱完成',
                    220: '用户存寄件箱中（开门完成）'
                },
                '0xBCA': { // 用户寄件存寄件箱格口信息
                    104: '4#位置',
                    105: '5#位置',
                    106: '6#位置'
                },
                '0xBCC': { // 系统状态信息（写）
                    10: '开启自动模式',
                    11: '取消自动模式',
                    20: '开启暂停模式',
                    21: '取消暂停模式',
                    30: '开启急停模式',
                    31: '取消急停模式'
                },
                '0xBCD': { // 系统状态信息（读）
                    12: '自动状态',
                    22: '暂停状态',
                    32: '急停状态'
                },
                '0xBCE': { // 故障清除
                    10: '故障清除',
                    11: '清除完成'
                },
                '0xBD2': { // 用户寄件格口状态
                    0: '空位',
                    10: '有空寄件箱，可下发寄件码',
                    20: '无空寄件箱，不可下发寄件码'
                }
            };
            
            // 系统报警寄存器（0xBFE-0xC0A）
            const alarmRegisters = ['0xBFE', '0xBFF', '0xC00', '0xC01', '0xC02', '0xC03', '0xC04', '0xC05', '0xC06', '0xC07', '0xC08', '0xC09', '0xC0A'];
            if (alarmRegisters.includes(address)) {
                return decValue === 11 ? '故障' : '正常';
            }
            
            // 气象站数据直接显示数值
            const weatherRegisters = ['0x8FC', '0x8FE', '0x900', '0x902', '0x904', '0x906'];
            if (weatherRegisters.includes(address)) {
                const weatherUnits = {
                    '0x8FC': '%', // 湿度
                    '0x8FE': '°C', // 温度
                    '0x900': '级', // 风力
                    '0x902': 'mm', // 雨量
                    '0x904': 'm/s', // 风速
                    '0x906': '°' // 风向
                };
                return `${decValue}${weatherUnits[address] || ''}`;
            }
            
            // 寄件码和重量直接显示数值
            if (address === '0xBC0' || address === '0xBC1' || address === '0xBD0' || address === '0xBD1') {
                return `${decValue}`;
            }
            if (address === '0xBCB') {
                return `${decValue}KG`;
            }
            
            // 查找状态描述
            if (statusMap[address] && statusMap[address][decValue] !== undefined) {
                return statusMap[address][decValue];
            }
            
            return '未知状态';
        }

        // 更新寄存器显示
        function updateRegisterDisplay() {
            const container = document.getElementById('registerContainer');
            
            if (Object.keys(registerData).length === 0) {
                container.innerHTML = '<div class="loading-message">暂无寄存器数据</div>';
                return;
            }
            
            // 按类别分组寄存器
            const categories = {
                '舱门和停机坪': ['0xBB8', '0xBB9'],
                '无人机存取包裹': ['0xBBA', '0xBBB', '0xBBC', '0xBBD', '0xBBE'],
                '用户取包裹': ['0xBC0', '0xBC1', '0xBC2', '0xBC3'],
                '用户回收包裹': ['0xBC4', '0xBC5'],
                '用户寄件': ['0xBC6', '0xBC7', '0xBCA', '0xBCB'],
                '系统状态和寄件码': ['0xBCC', '0xBCD', '0xBCE', '0xBD0', '0xBD1', '0xBD2'],
                '气象站': ['0x8FC', '0x8FE', '0x900', '0x902', '0x904', '0x906'],
                '系统报警': ['0xBFE', '0xBFF', '0xC00', '0xC01', '0xC02', '0xC03', '0xC04', '0xC05', '0xC06', '0xC07', '0xC08', '0xC09', '0xC0A']
            };
            
            let html = '<table class="register-table">';
            html += '<thead><tr><th>地址</th><th>名称</th><th>十六进制值</th><th>十进制值</th><th>描述</th><th>当前状态</th></tr></thead><tbody>';
            
            // 按类别显示寄存器
            for (const [categoryName, addresses] of Object.entries(categories)) {
                html += `<tr class="register-category"><td colspan="6">${categoryName}</td></tr>`;
                
                for (const addr of addresses) {
                    const reg = registerData[addr];
                    if (reg) {
                        const statusClass = reg.error ? 'register-error' : 'register-success';
                        const hexValue = reg.value || 'N/A';
                        const decValue = reg.decimal !== null ? reg.decimal : 'N/A';
                        
                        // 获取状态描述
                        let statusDescription = '未知';
                        if (!reg.error && reg.decimal !== null) {
                            statusDescription = getRegisterStatusDescription(addr, reg.decimal);
                        } else if (reg.error) {
                            statusDescription = reg.error;
                        }
                        
                        html += `<tr>`;
                        html += `<td class="register-value">${addr}</td>`;
                        html += `<td>${reg.name}</td>`;
                        html += `<td class="register-value ${statusClass}">${hexValue}</td>`;
                        html += `<td class="register-value ${statusClass}">${decValue}</td>`;
                        html += `<td>${reg.description}</td>`;
                        html += `<td class="${statusClass}" style="font-weight: bold;">${statusDescription}</td>`;
                        html += `</tr>`;
                    }
                }
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // 开始寄存器监视
        function startRegisterMonitoring() {
            if (registerMonitoringInterval) {
                addLog('寄存器监视已在运行中');
                return;
            }
            
            addLog('开始监视所有寄存器');
            document.getElementById('monitorStatus').textContent = '监视状态: 运行中';
            
            // 立即获取一次数据
            getAllRegisters();
            
            // 每5秒轮询一次
            registerMonitoringInterval = setInterval(() => {
                getAllRegisters();
            }, 5000);
        }

        // 停止寄存器监视
        function stopRegisterMonitoring() {
            if (registerMonitoringInterval) {
                clearInterval(registerMonitoringInterval);
                registerMonitoringInterval = null;
                document.getElementById('monitorStatus').textContent = '监视状态: 停止';
                addLog('已停止监视寄存器');
            } else {
                addLog('寄存器监视未在运行');
            }
        }

        // 手动刷新寄存器
        function refreshRegisters() {
            addLog('手动刷新寄存器数据');
            getAllRegisters();
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            initSecurityKey();
            getSystemStatus();
            getDoorStatus();
            getPickupStatus();
            getSendStatus();
            addLog('控制面板已加载');
        });

        // 定时刷新状态
        setInterval(getSystemStatus, 30000);
        
        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', function() {
            if (registerMonitoringInterval) {
                clearInterval(registerMonitoringInterval);
            }
            if (sendMonitoringInterval) {
                clearInterval(sendMonitoringInterval);
            }
        });
    </script>
</body>
</html>