<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“¦ ç”¨æˆ·å¯„ä»¶æµç¨‹æµ‹è¯•</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ“¦ ç”¨æˆ·å¯„ä»¶æµç¨‹æµ‹è¯•</h1>
        
        <div class="main-content">
            <!-- å¯„ä»¶æ“ä½œé¢æ¿ -->
            <div class="send-panel">
                <h2>ğŸ“® å¯„ä»¶æ“ä½œæµç¨‹</h2>
                <p>æŒ‰ç…§åè®®æµç¨‹è¿›è¡Œå¯„ä»¶æ“ä½œæµ‹è¯•ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…å¯„ä»¶ç å¹¶å¼•å¯¼å®Œæˆå¯„ä»¶æµç¨‹</p>
                
                <div class="status-display" id="statusDisplay">
                    çŠ¶æ€ï¼šç­‰å¾…å¼€å§‹å¯„ä»¶æµç¨‹...
                </div>
                
                <!-- å¯„ä»¶ç æ˜¾ç¤º -->
                <div class="pickup-code-display" id="sendCodeDisplay">
                    <h3>ğŸ“‹ æ‚¨çš„å¯„ä»¶ç </h3>
                    <div class="pickup-code" id="sendCodeValue">------</div>
                    <p>è¯·è®°ä½æ­¤å¯„ä»¶ç ï¼Œç”¨äºåç»­æ“ä½œ</p>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="operation-buttons">
                    <button class="btn btn-primary" onclick="checkSendStatus()" id="checkBtn">
                        ğŸ“‹ æ£€æŸ¥å¯„ä»¶æ ¼å£çŠ¶æ€
                    </button>
                    <button class="btn btn-success" onclick="generateSendCode()" id="generateCodeBtn" disabled>
                        ğŸ¯ ç”Ÿæˆå¯„ä»¶ç 
                    </button>
                    <button class="btn btn-warning" onclick="takeEmptyBox()" id="takeBoxBtn" disabled>
                        ğŸ“¦ å–ç©ºç®±
                    </button>
                    <button class="btn btn-info" onclick="confirmPackage()" id="confirmBtn" disabled>
                        âœ… ç¡®è®¤å¯„ä»¶
                    </button>
                    <button class="btn btn-secondary" onclick="resetProcess()" id="resetBtn">
                        ğŸ”„ é‡ç½®æµç¨‹
                    </button>
                </div>
                
                <!-- å¯„ä»¶ç è¾“å…¥ -->
                <div class="input-group" id="sendCodeInput" style="display: none;">
                    <label for="sendCode">è¾“å…¥å¯„ä»¶ç è¿›è¡Œå–ç©ºç®±ï¼š</label>
                    <input type="text" id="sendCode" placeholder="è¯·è¾“å…¥6ä½å¯„ä»¶ç " maxlength="6">
                    <button class="btn btn-warning" onclick="inputSendCode()" style="margin-top: 10px;">
                        ğŸ”‘ ä½¿ç”¨å¯„ä»¶ç å–ç©ºç®±
                    </button>
                </div>
            </div>
            
            <!-- å¯„å­˜å™¨çŠ¶æ€ç›‘æ§ -->
            <div class="register-status">
                <h2>ğŸ“Š å¯„ä»¶ç›¸å…³å¯„å­˜å™¨çŠ¶æ€</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">å¯„ä»¶æ ¼å£çŠ¶æ€ (0xBD2)</div>
                        <div class="status-value" id="reg-bd2">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">å¯„ä»¶ç å‰ä¸‰ä½ (0xBD0)</div>
                        <div class="status-value" id="reg-bd0">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">å¯„ä»¶ç åä¸‰ä½ (0xBD1)</div>
                        <div class="status-value" id="reg-bd1">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">å¯„ä»¶æ“ä½œçŠ¶æ€ (0xBC7)</div>
                        <div class="status-value" id="reg-bc7">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">å¯„ä»¶ä½ç½®1 (0xBCA)</div>
                        <div class="status-value" id="reg-bca">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">å¯„ä»¶ä½ç½®2 (0xBCB)</div>
                        <div class="status-value" id="reg-bcb">-</div>
                    </div>
                </div>
                <div class="status-actions">
                    <button class="btn btn-info" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                    <button class="btn btn-secondary" onclick="toggleAutoRefresh()">â° è‡ªåŠ¨åˆ·æ–°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentStep = 0;
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let currentSendCode = null;
        
        // å¯„å­˜å™¨å€¼ç¼“å­˜
        let registerValues = {
            '0xBD2': '-',
            '0xBD0': '-',
            '0xBD1': '-',
            '0xBC7': '-',
            '0xBCA': '-',
            '0xBCB': '-'
        };
        
        // æ­¥éª¤çŠ¶æ€
        const STEPS = {
            CHECK: 0,
            GENERATE_CODE: 1,
            TAKE_BOX: 2,
            PACKAGE: 3,
            CONFIRM: 4,
            COMPLETED: 5
        };
        
        // æ£€æŸ¥å¯„ä»¶æ ¼å£çŠ¶æ€
        async function checkSendStatus() {
            updateStatus('ğŸ“‹ æ£€æŸ¥å¯„ä»¶æ ¼å£çŠ¶æ€...');
            
            try {
                // è¯»å–0xBD2å¯„å­˜å™¨æ£€æŸ¥å¯„ä»¶æ ¼å£çŠ¶æ€
                const result = await callAPI('/api/modbus/read', {
                    address: 3026 // 0xBD2
                });
                
                if (result.success) {
                    const value = result.data.value;
                    registerValues['0xBD2'] = value.toString();
                    
                    if (value === 10) { // 0x0A - æœ‰ç©ºå¯„ä»¶ç®±å¯å¯„ä»¶
                        updateStatus('âœ… æ£€æµ‹åˆ°ç©ºå¯„ä»¶ç®±ï¼Œå¯ä»¥å¼€å§‹å¯„ä»¶æµç¨‹');
                        enableButton('generateCodeBtn');
                        currentStep = STEPS.GENERATE_CODE;
                    } else if (value === 11) { // 0x0B - æ— ç©ºå¯„ä»¶ç®±ä¸å¯å¯„ä»¶
                        updateStatus('âŒ å½“å‰æ— ç©ºå¯„ä»¶ç®±ï¼Œæ— æ³•å¯„ä»¶');
                        resetButtons();
                        return;
                    } else {
                        updateStatus(`âš ï¸ å¯„ä»¶æ ¼å£çŠ¶æ€å¼‚å¸¸: ${value}`);
                    }
                } else {
                    updateStatus('âŒ è¯»å–å¯„ä»¶æ ¼å£çŠ¶æ€å¤±è´¥');
                }
            } catch (error) {
                updateStatus(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
            
            await refreshStatus();
        }
        
        // ç”Ÿæˆå¯„ä»¶ç 
        async function generateSendCode() {
            updateStatus('ğŸ¯ ç”Ÿæˆå¯„ä»¶ç ...');
            
            try {
                // ç”Ÿæˆ6ä½å¯„ä»¶ç 
                currentSendCode = Math.floor(100000 + Math.random() * 900000);
                const code1 = Math.floor(currentSendCode / 1000); // å‰ä¸‰ä½
                const code2 = currentSendCode % 1000; // åä¸‰ä½
                
                // ä¸‹å‘å¯„ä»¶ç å‰ä¸‰ä½åˆ°0xBD0
                await callAPI('/api/modbus/write', {
                    address: 3024, // 0xBD0
                    values: [code1]
                });
                registerValues['0xBD0'] = code1.toString();
                
                // ä¸‹å‘å¯„ä»¶ç åä¸‰ä½åˆ°0xBD1
                await callAPI('/api/modbus/write', {
                    address: 3025, // 0xBD1
                    values: [code2]
                });
                registerValues['0xBD1'] = code2.toString();
                
                // æ˜¾ç¤ºå¯„ä»¶ç 
                document.getElementById('sendCodeValue').textContent = currentSendCode;
                document.getElementById('sendCodeDisplay').style.display = 'block';
                document.getElementById('sendCodeInput').style.display = 'block';
                
                updateStatus('âœ… å¯„ä»¶ç å·²ç”Ÿæˆå¹¶ä¸‹å‘ï¼Œè¯·ä½¿ç”¨å¯„ä»¶ç å–ç©ºç®±');
                enableButton('takeBoxBtn');
                disableButton('generateCodeBtn');
                currentStep = STEPS.TAKE_BOX;
                
            } catch (error) {
                updateStatus(`âŒ ç”Ÿæˆå¯„ä»¶ç å¤±è´¥: ${error.message}`);
            }
            
            await refreshStatus();
        }
        
        // å–ç©ºç®±
        async function takeEmptyBox() {
            updateStatus('ğŸ“¦ å¼€å§‹å–ç©ºç®±æµç¨‹...');
            
            try {
                // æ¨¡æ‹Ÿç”¨æˆ·è¾“å…¥å¯„ä»¶ç å¹¶å–ç©ºç®±
                updateStatus('ğŸ“¦ æ­£åœ¨å–ç©ºç®±ï¼Œè¯·ç¨å€™...');
                
                // è½®è¯¢æ£€æŸ¥0xBC7å¯„å­˜å™¨çŠ¶æ€
                let attempts = 0;
                const maxAttempts = 30;
                
                while (attempts < maxAttempts) {
                    await sleep(1000);
                    
                    const result = await callAPI('/api/modbus/read', {
                        address: 3015 // 0xBC7
                    });
                    
                    if (result.success) {
                        const value = result.data.value;
                        registerValues['0xBC7'] = value.toString();
                        
                        if (value === 210) { // 0xD2 - æ­£åœ¨å–ç©ºç®±
                            updateStatus('ğŸ“¦ æ­£åœ¨å–ç©ºç®±ä¸­...');
                        } else if (value === 211) { // 0xD3 - å–ç©ºç®±å®Œæˆ
                            updateStatus('âœ… å–ç©ºç®±å®Œæˆï¼Œè¯·æ”¾å…¥å¯„ä»¶ç‰©å“');
                            enableButton('confirmBtn');
                            disableButton('takeBoxBtn');
                            currentStep = STEPS.PACKAGE;
                            break;
                        } else if (value === 220) { // 0xDC - ç”¨æˆ·å­˜å¯„ä»¶ç®±ä¸­
                            updateStatus('ğŸ“¦ æ£€æµ‹åˆ°ç”¨æˆ·æ­£åœ¨å­˜æ”¾ç‰©å“...');
                        }
                    }
                    
                    attempts++;
                }
                
                if (attempts >= maxAttempts) {
                    updateStatus('âŒ å–ç©ºç®±è¶…æ—¶ï¼Œè¯·æ£€æŸ¥è®¾å¤‡çŠ¶æ€');
                }
                
            } catch (error) {
                updateStatus(`âŒ å–ç©ºç®±å¤±è´¥: ${error.message}`);
            }
            
            await refreshStatus();
        }
        
        // ä½¿ç”¨è¾“å…¥çš„å¯„ä»¶ç å–ç©ºç®±
        async function inputSendCode() {
            const inputCode = document.getElementById('sendCode').value;
            
            if (!inputCode || inputCode.length !== 6) {
                updateStatus('âŒ è¯·è¾“å…¥æ­£ç¡®çš„6ä½å¯„ä»¶ç ');
                return;
            }
            
            if (inputCode !== currentSendCode.toString()) {
                updateStatus('âŒ å¯„ä»¶ç ä¸æ­£ç¡®ï¼Œè¯·é‡æ–°è¾“å…¥');
                return;
            }
            
            updateStatus('âœ… å¯„ä»¶ç éªŒè¯æˆåŠŸï¼Œå¼€å§‹å–ç©ºç®±');
            await takeEmptyBox();
        }
        
        // ç¡®è®¤å¯„ä»¶
        async function confirmPackage() {
            updateStatus('âœ… ç¡®è®¤å¯„ä»¶æ“ä½œ...');
            
            try {
                updateStatus('ğŸ“¦ æ­£åœ¨å­˜å‚¨å¯„ä»¶ç®±ï¼Œè¯·ç¨å€™...');
                
                // è½®è¯¢æ£€æŸ¥å­˜å‚¨å®ŒæˆçŠ¶æ€
                let attempts = 0;
                const maxAttempts = 30;
                
                while (attempts < maxAttempts) {
                    await sleep(1000);
                    
                    const result = await callAPI('/api/modbus/read', {
                        address: 3015 // 0xBC7
                    });
                    
                    if (result.success) {
                        const value = result.data.value;
                        registerValues['0xBC7'] = value.toString();
                        
                        if (value === 210) { // 0xD2 - æ­£åœ¨å­˜å¯„ä»¶ç®±
                            updateStatus('ğŸ“¦ æ­£åœ¨å­˜å‚¨å¯„ä»¶ç®±ä¸­...');
                        } else if (value === 211) { // 0xD3 - å­˜å¯„ä»¶ç®±å®Œæˆ
                            updateStatus('âœ… å¯„ä»¶å®Œæˆï¼');
                            
                            // è¯»å–å¯„ä»¶ä½ç½®ä¿¡æ¯
                            const bcaResult = await callAPI('/api/modbus/read', {
                                address: 3018 // 0xBCA
                            });
                            const bcbResult = await callAPI('/api/modbus/read', {
                                address: 3019 // 0xBCB
                            });
                            
                            if (bcaResult.success && bcbResult.success) {
                                registerValues['0xBCA'] = bcaResult.data.value.toString();
                                registerValues['0xBCB'] = bcbResult.data.value.toString();
                                updateStatus(`âœ… å¯„ä»¶å®Œæˆï¼ä½ç½®ä¿¡æ¯ - BCA: ${bcaResult.data.value}, BCB: ${bcbResult.data.value}`);
                            }
                            
                            disableButton('confirmBtn');
                            currentStep = STEPS.COMPLETED;
                            
                            // æ˜¾ç¤ºå®Œæˆæç¤º
                            setTimeout(() => {
                                alert(`ğŸ‰ å¯„ä»¶æˆåŠŸï¼\nå¯„ä»¶ç : ${currentSendCode}\nè¯·ä¿å­˜å¥½å¯„ä»¶ç ç”¨äºåç»­æŸ¥è¯¢`);
                            }, 1000);
                            
                            break;
                        }
                    }
                    
                    attempts++;
                }
                
                if (attempts >= maxAttempts) {
                    updateStatus('âŒ å¯„ä»¶ç¡®è®¤è¶…æ—¶ï¼Œè¯·æ£€æŸ¥è®¾å¤‡çŠ¶æ€');
                }
                
            } catch (error) {
                updateStatus(`âŒ ç¡®è®¤å¯„ä»¶å¤±è´¥: ${error.message}`);
            }
            
            await refreshStatus();
        }
        
        // é‡ç½®æµç¨‹
        function resetProcess() {
            currentStep = STEPS.CHECK;
            currentSendCode = null;
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            resetButtons();
            
            // éšè—å¯„ä»¶ç æ˜¾ç¤º
            document.getElementById('sendCodeDisplay').style.display = 'none';
            document.getElementById('sendCodeInput').style.display = 'none';
            document.getElementById('sendCode').value = '';
            
            updateStatus('ğŸ”„ æµç¨‹å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°å¼€å§‹å¯„ä»¶');
        }
        
        // åˆ·æ–°å¯„å­˜å™¨çŠ¶æ€
        async function refreshStatus() {
            try {
                // è¯»å–æ‰€æœ‰ç›¸å…³å¯„å­˜å™¨
                const registers = {
                    '0xBD2': 3026,
                    '0xBD0': 3024,
                    '0xBD1': 3025,
                    '0xBC7': 3015,
                    '0xBCA': 3018,
                    '0xBCB': 3019
                };
                
                for (const [regName, address] of Object.entries(registers)) {
                    try {
                        const result = await callAPI('/api/modbus/read', {
                            address: address
                        });
                        
                        if (result.success) {
                            registerValues[regName] = result.data.value.toString();
                        }
                    } catch (error) {
                        console.error(`è¯»å–å¯„å­˜å™¨ ${regName} å¤±è´¥:`, error);
                    }
                }
                
                // æ›´æ–°æ˜¾ç¤º
                const registerElements = {
                    'reg-bd2': registerValues['0xBD2'],
                    'reg-bd0': registerValues['0xBD0'],
                    'reg-bd1': registerValues['0xBD1'],
                    'reg-bc7': registerValues['0xBC7'],
                    'reg-bca': registerValues['0xBCA'],
                    'reg-bcb': registerValues['0xBCB']
                };
                
                for (const [elementId, value] of Object.entries(registerElements)) {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = value || '-';
                    }
                }
                
            } catch (error) {
                console.error('åˆ·æ–°çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            if (isAutoRefresh) {
                clearInterval(autoRefreshInterval);
                isAutoRefresh = false;
                document.querySelector('[onclick="toggleAutoRefresh()"]').textContent = 'â° è‡ªåŠ¨åˆ·æ–°';
                updateStatus('â¸ï¸ è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
            } else {
                autoRefreshInterval = setInterval(refreshStatus, 2000);
                isAutoRefresh = true;
                document.querySelector('[onclick="toggleAutoRefresh()"]').textContent = 'â¹ï¸ åœæ­¢åˆ·æ–°';
                updateStatus('â–¶ï¸ è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨');
            }
        }
        
        // å·¥å…·å‡½æ•°
        function updateStatus(message) {
            const statusElement = document.getElementById('statusDisplay');
            if (statusElement) {
                statusElement.textContent = `çŠ¶æ€ï¼š${message}`;
            }
            console.log(message);
        }
        
        function enableButton(buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = false;
                button.classList.add('pulse');
                setTimeout(() => button.classList.remove('pulse'), 2000);
            }
        }
        
        function disableButton(buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = true;
                button.classList.remove('pulse');
            }
        }
        
        function resetButtons() {
            const buttons = ['generateCodeBtn', 'takeBoxBtn', 'confirmBtn'];
            buttons.forEach(buttonId => {
                disableButton(buttonId);
            });
            enableButton('checkBtn');
        }
        
        async function callAPI(endpoint, data) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹å¯„ä»¶æµç¨‹æµ‹è¯•');
            resetButtons();
            refreshStatus();
        });
    </script>
</body>
</html>